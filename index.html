<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Controle Felito — Pedidos por Nº</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Alice&display=swap" rel="stylesheet">
  <style>
    :root { --green:#012b29; --yellow:#e9b42e; --cream:#f2efeb; }
    * { box-sizing:border-box; font-family: 'Alice', serif; }
    body { margin:0; padding:12px; background:var(--green); color:var(--green); }
    .app { max-width:1100px; margin:auto; background:var(--cream); padding:16px; border-radius:16px; border:2px solid var(--yellow); box-shadow:0 8px 20px rgba(0,0,0,0.25); }
    .logo { text-align:center; margin-bottom:8px; }
    .logo h1 { margin:0; color:var(--yellow); letter-spacing:4px; }
    .subtitle { text-align:center; margin-bottom:12px; font-size:0.95rem; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
    .badge { background:var(--green); color:var(--cream); padding:8px 12px; border-radius:12px; font-weight:700; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
    form { display:grid; grid-template-columns: repeat(auto-fit,minmax(150px,1fr)); gap:8px; margin-bottom:10px; }
    label { display:block; font-size:0.8rem; margin-bottom:4px; }
    input, select { width:100%; padding:8px; border-radius:8px; border:1px solid #ccc; background:#fffaf6; }
    button { border-radius:999px; padding:8px 12px; border:none; cursor:pointer; font-weight:700; }
    .btn-primary { background:var(--yellow); color:var(--green); }
    .btn-secondary { background:#ded6cb; color:var(--green); }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
    .table-wrapper { width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; margin-top:6px; }
    table { width:100%; border-collapse:collapse; min-width:720px; font-size:0.9rem; }
    th, td { padding:8px; border-bottom:1px solid #ddd; white-space:nowrap; text-align:left; }
    th { background:#e6dfd4; }
    tr:nth-child(even) td { background:#f9f6f1; }
    .status-cell select { border:none; padding:6px; background:transparent; font-weight:700; cursor:pointer; }
    .status-A-Fazer{background:#fff3cd;} .status-À-Entregar{background:#cce5ff;} .status-Entregue{background:#d4edda;} .status-Pago{background:var(--yellow);} .status-Cancelado{background:#f8d7da;}
    .actions button { margin:2px; font-size:0.85rem; }
    .totals { display:flex; justify-content:space-between; gap:12px; margin-top:8px; flex-wrap:wrap; }
    .cart { border:1px dashed #c9c1b6; padding:8px; border-radius:8px; background:#fffdf8; margin-bottom:10px; }
    .cart-list { margin-top:8px; font-size:0.9rem; }
    .small { font-size:0.85rem; color:#555; }
    @media(max-width:600px){
      body{padding:8px;} .app{padding:12px;} table{min-width:600px;} form{grid-template-columns:1fr 1fr;}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="logo"><h1>FELITO</h1></div>
    <div class="subtitle">Use o fluxo: montar item → adicionar ao pedido atual → finalizar pedido</div>

    <div class="topbar">
      <div class="badge">Pedido atual: <span id="pedidoAtualBadge">001</span></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="btnNovoPedido" class="btn-secondary">Iniciar novo pedido</button>
        <button id="btnForcarNumero" class="btn-secondary">Definir nº manual</button>
        <button id="btnExport" class="btn-secondary">Exportar (JSON)</button>
        <button id="btnImport" class="btn-secondary">Importar (JSON)</button>
        <input type="file" id="fileImport" accept="application/json" style="display:none"/>
      </div>
    </div>

    <!-- Form para montar item (passo 1) -->
    <form id="form-item">
      <div>
        <label>Cliente</label>
        <input id="cliente" placeholder="Nome do cliente" />
      </div>
      <div>
        <label>Tamanho</label>
        <select id="tamanho" required>
          <option>240 mL</option><option>480 mL</option><option>1,5 L</option>
        </select>
      </div>
      <div>
        <label>Quantidade</label>
        <input type="number" id="quantidade" min="1" value="1" required />
      </div>
      <div>
        <label>Sabor</label>
        <select id="sabor" required>
          <option>Abacate</option><option>Baunilha</option><option>Doce de Leite</option><option>Doce de Leite com Coco</option><option>Limão com Manjericão</option><option>Limão Siciliano</option><option>Maracujá</option><option>Morango</option><option>Romeu & Julieta</option><option>Strogonoff de Nozes</option>
        </select>
      </div>
      <div>
        <label>Valor Unitário (R$)</label>
        <input type="number" id="valor" step="0.01" required />
      </div>
      <div>
        <label>Status</label>
        <select id="status">
          <option>A Fazer</option><option>À Entregar</option><option>Entregue</option><option>Pago</option><option>Cancelado</option>
        </select>
      </div>

      <!-- botões do carrinho (passo 2) -->
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <button type="button" id="btnAdicionarCarrinho" class="btn-primary">Adicionar ao pedido</button>
        <button type="button" id="btnFinalizarPedido" class="btn-secondary">Finalizar pedido (gravar tudo)</button>
        <button type="button" id="btnCancelarCarrinho" class="btn-secondary">Cancelar pedido atual</button>
      </div>
    </form>

    <!-- Carrinho temporário (mostra itens do pedido atual antes de finalizar) -->
    <div class="cart">
      <div><strong>Resumo do pedido atual (<span id="pedidoAtualBadge2">001</span>)</strong> <span class="small">adicione itens e clique em "Finalizar pedido" para gravar</span></div>
      <div id="cartList" class="cart-list"><em>Nenhum item adicionado ainda.</em></div>
      <div style="margin-top:8px;" class="small">Dica: clique em "Iniciar novo pedido" para começar outro pedido manualmente (ou após finalizar o atual o número incrementa automaticamente).</div>
    </div>

    <!-- Tabela principal -->
    <div class="table-wrapper">
      <table>
        <thead>
          <tr><th>Pedido</th><th>Data</th><th>Cliente</th><th>Tam.</th><th>Qtd</th><th>Sabor</th><th>R$ Unit.</th><th>Total</th><th>Status</th><th>Ações</th></tr>
        </thead>
        <tbody id="lista"></tbody>
      </table>
    </div>

    <div class="totals">
      <div>Itens: <strong id="count">0</strong></div>
      <div>Total: <strong id="sumTotal">R$ 0,00</strong></div>
    </div>
  </div>

<script>
/* ====== STORAGE KEYS ====== */
const ITEMS_KEY = "felito_items_v3";
const NEXT_ORDER_KEY = "felito_next_order_v3";
const CART_KEY = "felito_cart_v3";

/* ====== DOM ====== */
const lista = document.getElementById("lista");
const countEl = document.getElementById("count");
const sumTotalEl = document.getElementById("sumTotal");
const pedidoBadge = document.getElementById("pedidoAtualBadge");
const pedidoBadge2 = document.getElementById("pedidoAtualBadge2");
const cartListEl = document.getElementById("cartList");
const fileImport = document.getElementById("fileImport");

/* inputs */
const clienteIn = document.getElementById("cliente");
const tamanhoIn = document.getElementById("tamanho");
const quantidadeIn = document.getElementById("quantidade");
const saborIn = document.getElementById("sabor");
const valorIn = document.getElementById("valor");
const statusIn = document.getElementById("status");

/* buttons */
const btnAdicionarCarrinho = document.getElementById("btnAdicionarCarrinho");
const btnFinalizarPedido = document.getElementById("btnFinalizarPedido");
const btnCancelarCarrinho = document.getElementById("btnCancelarCarrinho");
const btnNovoPedido = document.getElementById("btnNovoPedido");
const btnForcarNumero = document.getElementById("btnForcarNumero");
const btnExport = document.getElementById("btnExport");
const btnImport = document.getElementById("btnImport");

/* ====== DADOS ====== */
let items = JSON.parse(localStorage.getItem(ITEMS_KEY)) || [];
let cart = JSON.parse(localStorage.getItem(CART_KEY)) || []; // itens temporários do pedido atual
let nextOrder = Number(localStorage.getItem(NEXT_ORDER_KEY) || 1);

/* ====== HELPERS ====== */
function pad(n){ return String(n).padStart(3,'0'); }
function getCurrentOrder(){ return pad(nextOrder); }
function saveAll(){ localStorage.setItem(ITEMS_KEY, JSON.stringify(items)); localStorage.setItem(CART_KEY, JSON.stringify(cart)); localStorage.setItem(NEXT_ORDER_KEY, String(nextOrder)); }
function formatBRL(v){ return "R$ " + Number(v).toFixed(2); }
function today(){ return new Date().toISOString().slice(0,10); }

/* ====== RENDER ====== */
function renderCart(){
  pedidoBadge.textContent = getCurrentOrder();
  pedidoBadge2.textContent = getCurrentOrder();
  if(!cart.length){ cartListEl.innerHTML = "<em>Nenhum item adicionado ainda.</em>"; return; }
  let html = "<ol style='padding-left:18px;margin:6px 0;'>";
  cart.forEach((c, idx) => {
    html += `<li>${c.tam} • ${c.sabor} • ${c.qtd} x ${formatBRL(c.valor)} = <strong>${formatBRL(c.qtd*c.valor)}</strong> <button style="margin-left:8px;border-radius:8px;padding:2px 6px" onclick="removerDoCarrinho(${idx})">Rem</button></li>`;
  });
  html += "</ol>";
  cartListEl.innerHTML = html;
}

function renderTable(){
  lista.innerHTML = "";
  let total = 0;
  items.forEach((p,i) => {
    const valorTotal = p.qtd * p.valor;
    total += valorTotal;
    const statusClass = "status-" + p.status.replace(" ", "-");
    lista.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${p.pedido}</td>
        <td>${p.data}</td>
        <td>${p.cliente}</td>
        <td>${p.tam}</td>
        <td>${p.qtd}</td>
        <td>${p.sabor}</td>
        <td>${formatBRL(p.valor)}</td>
        <td>${formatBRL(valorTotal)}</td>
        <td class="status-cell ${statusClass}">
          <select onchange="atualizarStatus(${i}, this.value)">
            <option ${p.status==="A Fazer" ? "selected":""}>A Fazer</option>
            <option ${p.status==="À Entregar" ? "selected":""}>À Entregar</option>
            <option ${p.status==="Entregue" ? "selected":""}>Entregue</option>
            <option ${p.status==="Pago" ? "selected":""}>Pago</option>
            <option ${p.status==="Cancelado" ? "selected":""}>Cancelado</option>
          </select>
        </td>
        <td>
          <button onclick="duplicarItem(${i})" class="btn-secondary">Duplicar</button>
          <button onclick="excluir(${i})" class="btn-secondary">Excluir</button>
        </td>
      </tr>
    `);
  });
  countEl.innerText = items.length;
  sumTotalEl.innerText = formatBRL(total);
}

/* ====== CRUD e ações ====== */
function removerDoCarrinho(i){
  cart.splice(i,1);
  saveAll();
  renderCart();
}

btnAdicionarCarrinho.onclick = () => {
  // validação básica
  const cliente = (clienteIn.value || "Cliente").trim();
  const tam = tamanhoIn.value;
  const qtd = Number(quantidadeIn.value) || 1;
  const sabor = saborIn.value;
  const valor = Number(valorIn.value) || 0;
  const status = statusIn.value;

  if(!sabor || !tam || qtd <= 0 || valor <= 0){ alert("Preencha Sabor, Tamanho, Quantidade e Valor (maior que zero)."); return; }

  const item = {
    pedido: getCurrentOrder(),
    data: today(),
    cliente,
    tam,
    qtd,
    sabor,
    valor,
    status
  };
  cart.push(item);
  saveAll();
  renderCart();

  // opcional: limpa só o sabor e quantidade (pra adicionar próximo item rápido)
  saborIn.selectedIndex = 0;
  quantidadeIn.value = 1;
  valorIn.value = "";
};

btnFinalizarPedido.onclick = () => {
  if(!cart.length){ alert("Carrinho vazio — adicione pelo menos 1 item ao pedido."); return; }
  // copia itens do cart para items
  cart.forEach(it => items.push({...it}));
  // esvazia cart, incrementa nextOrder
  cart = [];
  nextOrder = nextOrder + 1;
  saveAll();
  renderCart();
  renderTable();
  alert("Pedido finalizado e gravado. Nº do próximo pedido: " + getCurrentOrder());
};

btnCancelarCarrinho.onclick = () => {
  if(!cart.length){ alert("Carrinho vazio."); return; }
  if(!confirm("Cancelar este pedido atual? Todos os itens no carrinho serão perdidos.")) return;
  cart = [];
  saveAll();
  renderCart();
};

function atualizarStatus(i, novo){
  items[i].status = novo;
  saveAll();
  renderTable();
}

function excluir(i){
  if(!confirm("Excluir este item?")) return;
  items.splice(i,1);
  saveAll();
  renderTable();
}

function duplicarItem(i){
  const it = items[i];
  const copy = {...it};
  items.push(copy);
  saveAll();
  renderTable();
}

/* iniciar novo pedido manual (reseta o cart e aumenta nextOrder) */
btnNovoPedido.onclick = () => {
  if(cart.length){
    if(!confirm("Ainda há itens no carrinho do pedido atual. Deseja descartá-los e iniciar novo pedido?")) return;
    cart = [];
  }
  nextOrder = nextOrder + 1;
  saveAll();
  renderCart();
};

/* definir número manual */
btnForcarNumero.onclick = () => {
  const resposta = prompt("Digite o número do pedido (apenas número). Ex: 5 -> 005", String(Number(nextOrder)));
  if(resposta === null) return;
  const n = Number(resposta);
  if(!Number.isInteger(n) || n < 1){ alert("Número inválido."); return; }
  nextOrder = n;
  saveAll();
  renderCart();
};

/* export/import */
btnExport.onclick = () => {
  const payload = { items, cart, nextOrder };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "felito_backup_" + new Date().toISOString().slice(0,19).replace(/[:]/g,"") + ".json";
  a.click();
  URL.revokeObjectURL(url);
};

btnImport.onclick = () => fileImport.click();
fileImport.onchange = async (evt) => {
  const f = evt.target.files[0]; if(!f) return;
  const text = await f.text();
  try{
    const data = JSON.parse(text);
    if(!data || !Array.isArray(data.items)) throw new Error("Formato do arquivo inválido");
    if(!confirm("Importar irá substituir os dados atuais (itens + carrinho + nº do pedido). Continuar?")) return;
    items = data.items || [];
    cart = data.cart || [];
    nextOrder = Number(data.nextOrder) || 1;
    saveAll();
    renderCart();
    renderTable();
    fileImport.value = "";
  }catch(err){ alert("Erro ao importar: " + err.message); }
};

/* inicial */
if(!localStorage.getItem(NEXT_ORDER_KEY)) { localStorage.setItem(NEXT_ORDER_KEY, String(nextOrder)); }
if(!localStorage.getItem(ITEMS_KEY)) { localStorage.setItem(ITEMS_KEY, JSON.stringify([])); }
renderCart();
renderTable();
</script>
</body>
</html>
