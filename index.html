<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Controle Felito — Pedidos por Nº (com preços + WhatsApp)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Alice&display=swap" rel="stylesheet">
  <style>
    :root { --green:#012b29; --yellow:#e9b42e; --cream:#f2efeb; }
    * { box-sizing:border-box; font-family: 'Alice', serif; }
    body { margin:0; padding:12px; background:var(--green); color:var(--green); }
    .app { max-width:1100px; margin:auto; background:var(--cream); padding:16px; border-radius:16px; border:2px solid var(--yellow); box-shadow:0 8px 20px rgba(0,0,0,0.25); }
    .logo { text-align:center; margin-bottom:8px; }
    .logo h1 { margin:0; color:var(--yellow); letter-spacing:4px; }
    .subtitle { text-align:center; margin-bottom:12px; font-size:0.95rem; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
    .badge { background:var(--green); color:var(--cream); padding:8px 12px; border-radius:12px; font-weight:700; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
    form { display:grid; grid-template-columns: repeat(auto-fit,minmax(150px,1fr)); gap:8px; margin-bottom:10px; }
    label { display:block; font-size:0.8rem; margin-bottom:4px; }
    input, select { width:100%; padding:8px; border-radius:8px; border:1px solid #ccc; background:#fffaf6; }
    button { border-radius:999px; padding:8px 12px; border:none; cursor:pointer; font-weight:700; }
    .btn-primary { background:var(--yellow); color:var(--green); }
    .btn-secondary { background:#ded6cb; color:var(--green); }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
    .table-wrapper { width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; margin-top:6px; }
    table { width:100%; border-collapse:collapse; min-width:720px; font-size:0.9rem; }
    th, td { padding:8px; border-bottom:1px solid #ddd; white-space:nowrap; text-align:left; }
    th { background:#e6dfd4; }
    tr:nth-child(even) td { background:#f9f6f1; }
    .status-cell select { border:none; padding:6px; background:transparent; font-weight:700; cursor:pointer; }
    .status-A-Fazer{background:#fff3cd;} .status-À-Entregar{background:#cce5ff;} .status-Entregue{background:#d4edda;} .status-Pago{background:var(--yellow);} .status-Cancelado{background:#f8d7da;}
    .actions button { margin:2px; font-size:0.85rem; }
    .totals { display:flex; justify-content:space-between; gap:12px; margin-top:8px; flex-wrap:wrap; }
    .cart { border:1px dashed #c9c1b6; padding:8px; border-radius:8px; background:#fffdf8; margin-bottom:10px; }
    .cart-list { margin-top:8px; font-size:0.9rem; }
    .small { font-size:0.85rem; color:#555; }
    @media(max-width:600px){ body{padding:8px;} .app{padding:12px;} table{min-width:600px;} form{grid-template-columns:1fr 1fr;} }
  </style>
</head>
<body>
  <div class="app">
    <div class="logo"><h1>FELITO</h1></div>
    <div class="subtitle">Fluxo: montar item → adicionar ao pedido atual → finalizar pedido. Valores auto preenchidos (editáveis).</div>

    <div class="topbar">
      <div class="badge">Pedido atual: <span id="pedidoAtualBadge">001</span></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="btnNovoPedido" class="btn-secondary">Iniciar novo pedido</button>
        <button id="btnForcarNumero" class="btn-secondary">Definir nº manual</button>
        <button id="btnExportCSV" class="btn-secondary">Exportar CSV</button>
        <button id="btnImportCSV" class="btn-secondary">Importar CSV</button>
        <button id="btnExportJSON" class="btn-secondary">Exportar JSON</button>
        <button id="btnImportJSON" class="btn-secondary">Importar JSON</button>
        <button id="btnSendCartWhatsApp" class="btn-primary">Enviar carrinho (WhatsApp)</button>
        <input type="file" id="fileImportCSV" accept=".csv,text/csv" style="display:none"/>
        <input type="file" id="fileImportJSON" accept="application/json" style="display:none"/>
      </div>
    </div>

    <!-- Form para montar item (passo 1) -->
    <form id="form-item">
      <div>
        <label>Cliente</label>
        <input id="cliente" placeholder="Nome do cliente" />
      </div>
      <div>
        <label>Tamanho</label>
        <select id="tamanho" required>
          <option>240 mL</option><option>480 mL</option><option>1,5 L</option>
        </select>
      </div>
      <div>
        <label>Quantidade</label>
        <input type="number" id="quantidade" min="1" value="1" required />
      </div>
      <div>
        <label>Sabor</label>
        <select id="sabor" required>
          <option>Abacate</option><option>Baunilha</option><option>Doce de Leite</option><option>Doce de Leite com Coco</option><option>Limão com Manjericão</option><option>Limão Siciliano</option><option>Maracujá</option><option>Morango</option><option>Romeu & Julieta</option><option>Strogonoff de Nozes</option>
        </select>
      </div>
      <div>
        <label>Valor Unitário (R$)</label>
        <input type="number" id="valor" step="0.01" required />
      </div>
      <div>
        <label>Status</label>
        <select id="status">
          <option>A Fazer</option><option>À Entregar</option><option>Entregue</option><option>Pago</option><option>Cancelado</option>
        </select>
      </div>

      <!-- botões do carrinho (passo 2) -->
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <button type="button" id="btnAdicionarCarrinho" class="btn-primary">Adicionar ao pedido</button>
        <button type="button" id="btnFinalizarPedido" class="btn-secondary">Finalizar pedido (gravar tudo)</button>
        <button type="button" id="btnCancelarCarrinho" class="btn-secondary">Cancelar pedido atual</button>
      </div>
    </form>

    <!-- Carrinho temporário -->
    <div class="cart">
      <div><strong>Resumo do pedido atual (<span id="pedidoAtualBadge2">001</span>)</strong> <span class="small">adicione itens e clique em "Finalizar pedido" para gravar</span></div>
      <div id="cartList" class="cart-list"><em>Nenhum item adicionado ainda.</em></div>
      <div style="margin-top:8px;" class="small">Dica: o campo Valor é preenchido automaticamente ao escolher sabor/tamanho, mas você pode editar para aplicar desconto. Cliente é auto-preenchido com o último nome usado.</div>
    </div>

    <!-- Tabela principal -->
    <div class="table-wrapper">
      <table>
        <thead>
          <tr><th>Pedido</th><th>Data</th><th>Cliente</th><th>Tam.</th><th>Qtd</th><th>Sabor</th><th>R$ Unit.</th><th>Total</th><th>Status</th><th>Ações</th></tr>
        </thead>
        <tbody id="lista"></tbody>
      </table>
    </div>

    <div class="totals">
      <div>Itens: <strong id="count">0</strong></div>
      <div>Total: <strong id="sumTotal">R$ 0,00</strong></div>
    </div>
  </div>

<script>
/* ========== Config de preços ========== */
const priceStandard = { "240 mL": 17.00, "480 mL": 30.00, "1,5 L": 85.00 };
const premiumFlavors = ["Romeu & Julieta","Doce de Leite com Coco","Strogonoff de Nozes"];
const pricePremium = { "240 mL": 20.00, "480 mL": 35.00, "1,5 L": 100.00 };

/* ========== Storage keys ========== */
const ITEMS_KEY = "felito_items_v4";
const NEXT_ORDER_KEY = "felito_next_order_v4";
const CART_KEY = "felito_cart_v4";
const LAST_CLIENT_KEY = "felito_last_client_v1";

/* ========== DOM ========== */
const lista = document.getElementById("lista");
const countEl = document.getElementById("count");
const sumTotalEl = document.getElementById("sumTotal");
const pedidoBadge = document.getElementById("pedidoAtualBadge");
const pedidoBadge2 = document.getElementById("pedidoAtualBadge2");
const cartListEl = document.getElementById("cartList");

const clienteIn = document.getElementById("cliente");
const tamanhoIn = document.getElementById("tamanho");
const quantidadeIn = document.getElementById("quantidade");
const saborIn = document.getElementById("sabor");
const valorIn = document.getElementById("valor");
const statusIn = document.getElementById("status");

const btnAdicionarCarrinho = document.getElementById("btnAdicionarCarrinho");
const btnFinalizarPedido = document.getElementById("btnFinalizarPedido");
const btnCancelarCarrinho = document.getElementById("btnCancelarCarrinho");
const btnNovoPedido = document.getElementById("btnNovoPedido");
const btnForcarNumero = document.getElementById("btnForcarNumero");
const btnExportCSV = document.getElementById("btnExportCSV");
const btnImportCSV = document.getElementById("btnImportCSV");
const btnExportJSON = document.getElementById("btnExportJSON");
const btnImportJSON = document.getElementById("btnImportJSON");
const fileImportCSV = document.getElementById("fileImportCSV");
const fileImportJSON = document.getElementById("fileImportJSON");
const btnSendCartWhatsApp = document.getElementById("btnSendCartWhatsApp");

/* ========== dados ========== */
let items = JSON.parse(localStorage.getItem(ITEMS_KEY)) || [];
let cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
let nextOrder = Number(localStorage.getItem(NEXT_ORDER_KEY) || 1);
let lastClient = localStorage.getItem(LAST_CLIENT_KEY) || "";

/* ========== helpers ========== */
function pad(n){ return String(n).padStart(3,'0'); }
function getCurrentOrder(){ return pad(nextOrder); }
function saveAll(){ localStorage.setItem(ITEMS_KEY, JSON.stringify(items)); localStorage.setItem(CART_KEY, JSON.stringify(cart)); localStorage.setItem(NEXT_ORDER_KEY, String(nextOrder)); localStorage.setItem(LAST_CLIENT_KEY, lastClient); }
function formatBRL(v){ return "R$ " + Number(v).toFixed(2); }
function today(){ return new Date().toISOString().slice(0,10); }
function defaultPriceFor(sabor, tamanho) {
  if (premiumFlavors.includes(sabor)) return pricePremium[tamanho] ?? priceStandard[tamanho];
  return priceStandard[tamanho] ?? 0;
}

/* ========== UI: auto preencher preço e cliente ========== */
function preencherPrecoPadrao() {
  const sabor = saborIn.value;
  const tamanho = tamanhoIn.value;
  const preco = defaultPriceFor(sabor, tamanho);
  if (preco) {
    const atual = Number(valorIn.value || 0);
    if (!valorIn.value || atual === 0) {
      valorIn.value = preco.toFixed(2);
    }
  }
}
saborIn.addEventListener("change", preencherPrecoPadrao);
tamanhoIn.addEventListener("change", preencherPrecoPadrao);

/* auto preencher cliente com último usado */
function preencherUltimoCliente() {
  if (lastClient) clienteIn.value = lastClient;
}
preencherUltimoCliente();

/* ========== render carrinho & tabela ========== */
function renderCart(){
  pedidoBadge.textContent = getCurrentOrder();
  pedidoBadge2.textContent = getCurrentOrder();
  if(!cart.length){ cartListEl.innerHTML = "<em>Nenhum item adicionado ainda.</em>"; return; }
  let html = "<ol style='padding-left:18px;margin:6px 0;'>";
  cart.forEach((c, idx) => {
    html += `<li>${c.tam} • ${c.sabor} • ${c.qtd} x ${formatBRL(c.valor)} = <strong>${formatBRL(c.qtd*c.valor)}</strong> <button style="margin-left:8px;border-radius:8px;padding:2px 6px" onclick="removerDoCarrinho(${idx})">Rem</button></li>`;
  });
  html += "</ol>";
  cartListEl.innerHTML = html;
}

function renderTable(){
  lista.innerHTML = "";
  let total = 0;
  items.forEach((p,i) => {
    const valorTotal = p.qtd * p.valor;
    total += valorTotal;
    const statusClass = "status-" + p.status.replace(" ", "-");
    lista.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${p.pedido}</td>
        <td>${p.data}</td>
        <td>${p.cliente}</td>
        <td>${p.tam}</td>
        <td>${p.qtd}</td>
        <td>${p.sabor}</td>
        <td>${formatBRL(p.valor)}</td>
        <td>${formatBRL(valorTotal)}</td>
        <td class="status-cell ${statusClass}">
          <select onchange="atualizarStatus(${i}, this.value)">
            <option ${p.status==="A Fazer" ? "selected":""}>A Fazer</option>
            <option ${p.status==="À Entregar" ? "selected":""}>À Entregar</option>
            <option ${p.status==="Entregue" ? "selected":""}>Entregue</option>
            <option ${p.status==="Pago" ? "selected":""}>Pago</option>
            <option ${p.status==="Cancelado" ? "selected":""}>Cancelado</option>
          </select>
        </td>
        <td>
          <button onclick="duplicarItem(${i})" class="btn-secondary">Duplicar</button>
          <button onclick="excluir(${i})" class="btn-secondary">Excluir</button>
          <button onclick="enviarLinhaWhatsApp(${i})" class="btn-primary">WhatsApp</button>
        </td>
      </tr>
    `);
  });
  countEl.innerText = items.length;
  sumTotalEl.innerText = formatBRL(total);
}

/* ========== ações ========== */
function removerDoCarrinho(i){ cart.splice(i,1); saveAll(); renderCart(); }
btnAdicionarCarrinho.onclick = () => {
  const cliente = (clienteIn.value || "Cliente").trim();
  const tam = tamanhoIn.value;
  const qtd = Number(quantidadeIn.value) || 1;
  const sabor = saborIn.value;
  const valor = Number(valorIn.value) || 0;
  const status = statusIn.value;
  if(!sabor || !tam || qtd <= 0 || valor <= 0){ alert("Preencha Sabor, Tamanho, Quantidade e Valor (maior que zero)."); return; }
  const item = { pedido: getCurrentOrder(), data: today(), cliente, tam, qtd, sabor, valor, status };
  cart.push(item);
  lastClient = cliente; // salva último cliente usado
  saveAll(); renderCart();
  // prepara próximo item: limpa flavor/valor/quantidade mantendo cliente
  quantidadeIn.value = 1;
  valorIn.value = "";
};
btnFinalizarPedido.onclick = () => {
  if(!cart.length){ alert("Carrinho vazio — adicione pelo menos 1 item ao pedido."); return; }
  cart.forEach(it => items.push({...it}));
  cart = [];
  nextOrder = nextOrder + 1;
  saveAll();
  renderCart(); renderTable();
  alert("Pedido finalizado e gravado. Nº do próximo pedido: " + getCurrentOrder());
};
btnCancelarCarrinho.onclick = () => {
  if(!cart.length){ alert("Carrinho vazio."); return; }
  if(!confirm("Cancelar este pedido atual? Todos os itens no carrinho serão perdidos.")) return;
  cart = []; saveAll(); renderCart();
};
function atualizarStatus(i, novo){ items[i].status = novo; saveAll(); renderTable(); }
function excluir(i){ if(!confirm("Excluir este item?")) return; items.splice(i,1); saveAll(); renderTable(); }
function duplicarItem(i){ const it = items[i]; items.push({...it}); saveAll(); renderTable(); }

/* novo pedido manual */
btnNovoPedido.onclick = () => {
  if(cart.length){
    if(!confirm("Ainda há itens no carrinho do pedido atual. Deseja descartá-los e iniciar novo pedido?")) return;
    cart = [];
  }
  nextOrder = nextOrder + 1;
  saveAll(); renderCart();
};
btnForcarNumero.onclick = () => {
  const resposta = prompt("Digite o número do pedido (apenas número). Ex: 5 -> 005", String(Number(nextOrder)));
  if(resposta === null) return;
  const n = Number(resposta);
  if(!Number.isInteger(n) || n < 1){ alert("Número inválido."); return; }
  nextOrder = n; saveAll(); renderCart();
};

/* export/import CSV & JSON (igual ao anterior) */
function toCSV(rows) {
  const sep = ";";
  return rows.map(r => r.map(cell => {
    if (cell === null || cell === undefined) return "";
    const s = String(cell);
    if (s.includes(sep) || s.includes('"') || s.includes("\n") || s.includes("\r")) {
      return `"${s.replace(/"/g,'""')}"`;
    }
    return s;
  }).join(sep)).join("\n");
}
btnExportCSV.onclick = () => {
  const rows = [["pedido","data","cliente","tam","qtd","sabor","valor","status"]];
  items.forEach(it => rows.push([it.pedido,it.data,it.cliente,it.tam,it.qtd,it.sabor, Number(it.valor).toFixed(2), it.status]));
  const csv = toCSV(rows);
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `felito_items_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
};
btnImportCSV.onclick = () => fileImportCSV.click();
fileImportCSV.onchange = async (e) => {
  const f = e.target.files[0]; if(!f) return;
  const text = await f.text();
  const sep = detectSeparator(text);
  const rows = parseCSV(text, sep);
  if (!rows.length) { alert("Arquivo vazio ou formato inválido."); fileImportCSV.value=""; return; }
  const header = rows[0].map(h => h.trim().toLowerCase());
  const needed = ["pedido","data","cliente","tam","qtd","sabor","valor","status"];
  const missing = needed.filter(n => !header.includes(n));
  if(missing.length){ alert("Colunas faltando no CSV: " + missing.join(", ")); fileImportCSV.value=""; return; }
  const ask = confirm("Importar CSV: clicar OK para SUBSTITUIR todos os dados atuais. Cancelar para ACRÉSCIMO (append).");
  const imported = [];
  for(let i=1;i<rows.length;i++){
    const row = rows[i];
    if(row.length === 0) continue;
    const obj = {};
    for(let c=0;c<row.length;c++){ const key = header[c]; obj[key] = row[c]; }
    const item = {
      pedido: String(obj.pedido || "").trim() || getCurrentOrder(),
      data: String(obj.data || "").trim() || today(),
      cliente: String(obj.cliente || "Cliente").trim(),
      tam: String(obj.tam || "240 mL").trim(),
      qtd: Number(obj.qtd || 1),
      sabor: String(obj.sabor || "").trim(),
      valor: Number((obj.valor || "0").toString().replace(",","." ) || 0),
      status: String(obj.status || "A Fazer")
    };
    imported.push(item);
  }
  if(ask) items = imported; else items = items.concat(imported);
  saveAll(); renderTable(); alert("Importação concluída. Linhas importadas: " + imported.length);
  fileImportCSV.value = "";
};
btnExportJSON.onclick = () => { const payload = { items, cart, nextOrder }; const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = "felito_backup_" + new Date().toISOString().slice(0,19).replace(/[:]/g,"") + ".json"; a.click(); URL.revokeObjectURL(url); };
btnImportJSON.onclick = () => fileImportJSON.click();
fileImportJSON.onchange = async (e) => {
  const f = e.target.files[0]; if(!f) return;
  const text = await f.text();
  try { const data = JSON.parse(text); if(!data || !Array.isArray(data.items)) throw new Error("Formato inválido"); if(!confirm("Importar JSON substituirá itens + carrinho + número do pedido. Continuar?")) return; items = data.items || []; cart = data.cart || []; nextOrder = Number(data.nextOrder) || 1; saveAll(); renderCart(); renderTable(); alert("Importação JSON concluída."); } catch(err){ alert("Erro ao importar JSON: " + err.message); }
  fileImportJSON.value = "";
};
function detectSeparator(text){ const lines = text.split(/\r\n|\n/).filter(l=>l.trim().length>0); if(!lines.length) return ";"; const first = lines[0]; const countSemicolon = (first.match(/;/g)||[]).length; const countComma = (first.match(/,/g)||[]).length; return countSemicolon >= countComma ? ";" : ","; }
function parseCSV(text, sep=";"){ const rows=[]; let cur=[], i=0, sb="", inQuotes=false; while(i<text.length){ const ch=text[i], next=text[i+1]; if(ch === '"'){ if(inQuotes && next === '"'){ sb+='"'; i+=2; continue; } inQuotes=!inQuotes; i++; continue; } if(!inQuotes && (ch===sep || ch==='\n' || ch==='\r')){ if(ch===sep){ cur.push(sb); sb=""; i++; continue; } cur.push(sb); sb=""; rows.push(cur); cur=[]; if(ch==='\r' && text[i+1]==='\n') i+=2; else i++; continue; } sb+=ch; i++; } if(sb.length>0 || cur.length>0){ cur.push(sb); rows.push(cur); } return rows; }

/* ========== WhatsApp helpers ========== */
function openWhatsAppWithText(text){
  // prefer wa.me (works on iOS: opens WhatsApp app if installed)
  const encoded = encodeURIComponent(text);
  const url = `https://wa.me/?text=${encoded}`;
  window.open(url, "_blank");
}

/* envia resumo do CART pelo WhatsApp */
btnSendCartWhatsApp.onclick = () => {
  if(!cart.length){ alert("Carrinho vazio."); return; }
  const lines = [`Pedido ${getCurrentOrder()} — RESUMO`];
  let total = 0;
  cart.forEach(it => {
    const subtotal = it.qtd * it.valor;
    total += subtotal;
    lines.push(`- ${it.qtd}x ${it.tam} ${it.sabor} • R$ ${it.valor.toFixed(2)} = R$ ${subtotal.toFixed(2)}`);
  });
  lines.push(`Total: R$ ${total.toFixed(2)}`);
  lines.push("");
  lines.push("Enviado via Felito");
  openWhatsAppWithText(lines.join("\n"));
};

/* envia somente a linha i via WhatsApp */
window.enviarLinhaWhatsApp = function(i){
  const it = items[i];
  if(!it) return;
  const txt = `Pedido ${it.pedido}\nCliente: ${it.cliente}\n${it.qtd}x ${it.tam} ${it.sabor}\nUnit.: R$ ${it.valor.toFixed(2)}\nTotal: R$ ${(it.qtd*it.valor).toFixed(2)}\nStatus: ${it.status}\n\nEnviado via Felito`;
  openWhatsAppWithText(txt);
};

/* expose some global functions used in template */
window.atualizarStatus = function(i, novo){ atualizarStatus(i, novo); };
window.excluir = excluir;
window.duplicarItem = duplicarItem;
window.removerDoCarrinho = removerDoCarrinho;

/* ========== inicial ======== */
if(!localStorage.getItem(NEXT_ORDER_KEY)) { localStorage.setItem(NEXT_ORDER_KEY, String(nextOrder)); }
if(!localStorage.getItem(ITEMS_KEY)) { localStorage.setItem(ITEMS_KEY, JSON.stringify([])); }
preencherPrecoPadrao();
preencherUltimoCliente();
renderCart();
renderTable();
</script>
</body>
</html>
